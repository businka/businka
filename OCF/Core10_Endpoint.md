[Copyright Open Connectivity Foundation, Inc. © 2016-2018. All rights Reserved](https://openconnectivity.org/)

# 10 Endpoint

## 10.1 Endpoint definition

Конкретное определение конечной точки зависит от используемого пакета протокола транспорта. Для примера CoAP через UDP через IPv6 конечная точка идентифицируется адресом IPv6 и номером порта UDP.

Каждое устройство OCF должно связываться, по меньшей мере, с одной конечной точкой, с помощью которой оно может обмениваться сообщениями запроса и ответа. Когда сообщение отправляется на конечную точку, оно должно быть доставлено на устройство OCF, которое связано с конечной точкой. Когда сообщение с запросом доставляется в конечную точку, компонент пути достаточно для определения целевого ресурса.

OCF-устройство может быть связано с несколькими конечными точками. Например, OCF-устройство может иметь несколько IP-адресов или номеров портов или поддерживать протокол CoAP и HTTP-передачи. Различные ресурсы в OCF-устройстве могут быть доступны с одной и той же конечной точкой или нужны разные.

Некоторые ресурсы могут использовать одну конечную точку, а другие - другую. Это зависит от реализации.

С другой стороны, конечную точку можно разделить между несколькими устройствами OCF, только когда есть способ четко обозначить целевой ресурс с URI запроса. Например, когда несколько серверов CoAP используют уникально разные пути URI для всех размещенных ресурсов, а реализация CoAP демультиплексирует по пути, они могут совместно использовать одну и ту же конечную точку CoAP. Однако это невозможно в этой версии спецификации, поскольку предопределенный URI (например, «/ oic / d») является обязательным для некоторых обязательных ресурсов (например, «oic.wk.d»).

## 10.2   Endpoint information

### 10.2.1 Введение

Конечная точка представлена информацией о конечной точке, которая состоит из двух элементов пары «ключ-значение», «ep» и «pri».

### 10.2.2 “ep”

«ep» представляет пакет протокола транспорта и локатор конечных точек, указанный следующим образом:

- **Transport Protocol Suite** - комбинация протоколов (например, CoAP + UDP + IPv6), с помощью которых сообщения запроса и ответа могут быть обменены на транзакцию RESTful (т. Е. CRUDN). Набор транспортного протокола должен указываться по названию схемы URI. Все имена схем, поддерживаемые этой спецификацией, регистрируются IANA, они перечислены в таблице 17. Поставщик может также использовать имя зарегистрированной схемы, отличное от IANA, для собственного использования (например, «com.example.foo»), это будет следовать синтаксис таких имен схем, определенных IETF RFC 7595. Поведение имени схемы, определенного поставщиком, не определено этой спецификацией. Все OCF определяли типы ресурсов при экспонировании информации о конечных точках в «eps» (см. Раздел 10.2.4), должны включать по крайней мере один «ep» с пакетом протокола передачи, как определено в таблице 17.
- **Endpoint Locator** - адрес (например, адрес IPv6 + номер порта), через который сообщение может быть отправлено на конечную точку и, в свою очередь, связано с OCF-устройством. Локатор конечных точек для «coap», «coaps», «coap + tcp», «coaps + tcp», «http» и «https» должен указываться как «IP-адрес: номер порта». Временные адреса не должны использоваться, поскольку локаторы конечных точек предназначены для приема входящих сеансов, тогда как временные адреса предназначены для инициирования исходящих сеансов (IETF RFC 4941). Более того, включение в «/oic/res» может привести к проблемам конфиденциальности (IETF RFC 7721).

  «ep» имеет в качестве своего значения URI (как указано в IETF RFC 3986) с компонентом схемы, указывающим пакет протокола передачи и компонент полномочий, указывающий локатор конечных точек:

```
"ep": "coap://[fe80::b1d6]:1111"
```

Текущий список «ep» с соответствующим пакетом Transport Protocol Suite показан в таблице 17:

| Transport Protocol Suite | scheme    | Endpoint Locator           | "ep" Value example                |
| ------------------------ | --------- | -------------------------- | --------------------------------- |
| **coap + udp + ip**      | coap      | IP address + port   number | coap://[fe80::b1d6]:1111          |
| **coaps + udp + ip**     | coaps     | IP address + port   number | coaps://[fe80::b1d6 ]:1122        |
| **coap + tcp + ip**      | coap+tcp  | IP address + port   number | coap+tcp://[2001:d b8a::123]:2222 |
| **coaps + tcp + ip**     | coaps+tcp | IP address + port   number | coaps+tcp://[2001:db8a::123]:2233 |
| **http + tcp + ip**      | http      | IP address + port   number | http://[2001:db8a::12 3]:1111     |
| **https + tcp + ip**     | https     | IP address + port   number | https://[2001:db8a::123]:1122     |

### 10.2.3 "pri"

Когда имеется несколько конечных точек, «pri» указывает приоритет среди них.
«pri» должно быть представлено как положительное целое число (например, «pri»: 1), и чем ниже значение, тем выше приоритет.

Значение «pri» по умолчанию равно 1, то есть когда «pri» не присутствует, он должен быть эквивалентен «pri»: 1.

### 10.2.4 Информация о конечной точке в параметре «eps»

Для передачи информации о конечных точках новый параметр связи «eps» определен в пункте 7.8.2.1.5. «eps» имеет массив элементов в качестве значения, и каждый элемент представляет информацию о конечной точке с двумя парами ключевого значения «ep» и «pri», из которых «ep» является обязательным, а «pri» является необязательным.

Информация о конечной точке в параметре «eps» действительна для целевого ресурса канала, то есть ресурса, указанного параметром «href». Информация о конечных точках в параметре «eps» может использоваться для доступа к другим ресурсам на устройстве, но такой доступ не гарантируется.

Ссылка с «eps»:

```json
{
    "anchor": "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/myLightSwitch",
    "rt": ["oic.r.switch.binary"],
    "if": ["oic.if.a",  "oic .if. baseline"],
    "p": {"bm": 3},
    "eps":  [
    	{"ep": "coap://[fe80::b1d6]:1111", "pri": 2}, 
    	{"ep": "coaps://[fe80::b1d6]:1122"}]
}
```

В предыдущем примере «anchor» представляет собой хостинг OCF Device, «href», целевой ресурс и «eps» для двух конечных точек для целевого ресурса.

Если для целевого ресурса канала требуется безопасное соединение (например, CoAPS), параметр «eps» должен использоваться для указания необходимой информации (например, номера порта) в полезной нагрузке OCF 1.0, поскольку используются только «сек» и «порт» в полезной нагрузке ОИС 1.1.

## 10.3 Endpoint discovery

### 10.3.1  Introduction

«Обнаружение конечных точек» определяется как процесс для клиента для получения информации о конечной точке для устройства или ресурса OCF.

### 10.3.2 Implicit discovery

Если устройство является источником сообщения CoAP (например, «/oic/res»), исходный IP-адрес и номер порта могут быть объединены для формирования Локатора конечных точек для устройства. Наряду с схемой «coap» и значением «pri» по умолчанию может быть сконфигурирована информация о конечной точке для устройства.

 Другими словами, ответное сообщение «/oic/res» с CoAP может неявно переносить информацию о конечной точке отвечающего устройства и, в свою очередь, все размещенные ресурсы, к которым можно получить доступ с тем же протоколом передачи CoAP.

### 10.3.3   Explicit discovery with "/oic/res" response

Информация о конечной точке может быть явно указана параметром «eps» ссылок в «/oic/res».

Как и в 10.3.2, ответ «/oic/res» может косвенно указывать информацию о конечной точке для некоторых Ресурсов, размещенных ответным устройством. Однако неявное обнаружение, т.e. вывод информации о конечных точках из сообщения ответа CoAP, может не работать для некоторых ресурсов на одном и том же устройстве. Например, некоторые ресурсы могут разрешать только защищенный доступ через CoAPS, для которого требуется параметр «eps» для указания номера порта. Кроме того, «/oic/res» может выставить целевой ресурс, принадлежащий другому устройству.

Когда конечная точка для целевого ресурса ссылки не может быть неявно выведена, параметр «eps» должен быть включен для предоставления явной информации о конечной точке, с которой клиент может получить доступ к целевому ресурсу. Чтобы получить доступ к целевому ресурсу ссылки, клиент может использовать параметр «eps» в ссылке, если он присутствует, и вернуться к неявному обнаружению, если нет.

Это относится к случаю «/oic/res» для каталога ресурсов или мостового устройства, которое обычно содержит ссылки для ресурсов, которые другие устройства размещают.

 Ответ «/oic/res» от мостового устройства с двумя мостовыми устройствами с параметром «eps» в ссылках:

```json
[
{
    "anchor": "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/res",
    "rel": "self",
    "rt": ["oic.wk.res"],
    "if": ["oic.if.ll", "oic.if.baseline"],
    "p": {"bm": 3},
    "eps": [
        {"ep": "coap://[2001:db8:a::b1d4]:55555"},
        {"ep": "coaps://[2001:db8:a::b1d4]:11111"}
    ]
},
{
    "anchor": "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/d",
    "rt": ["oic.wk.d", "oic.d.bridge"],
    "if": ["oic.if.r", "oic.if.baseline"],
    "p": {"bm": 3},
    "eps":  [
        {"ep": "coap://[2001:db8:a::b1d4]:55555"},
        {"ep":  "coaps://[2001:db8:a::b1d4]:11111"}
    ]
},
{
    "anchor": "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/p",
    "rt":  ["oic.wk.p"],
    "if":  ["oic.if.r",  "oic.if.baseline"],
    "p": {"bm": 3},
    "eps":  [
        {"ep": "coap://[2001:db8:a::b1d4]:55555"},
        {"ep": "coaps://[2001:db8:a::b1d4]:11111"}
    ]
},
{
    "anchor": "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/mySecureMode",
    "rt": ["oic.r.securemode"],
    "if": ["oic.if.rw", "oic.if.baseline"],
    "p": {"bm": 3},
    "eps": [{"ep": "coaps://[2001:db8:a::b1d4]:11111"}]
},
{
    "anchor": "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/sec/doxm",
    "rt":  ["oic.r.doxm"],
    "if":  ["oic.if.baseline"],
    "p": {"bm": 1},
    "eps":  [
        {"ep":  "coap://[2001:db8:a::b1d4]:55555"},
        {"ep":  "coaps://[2001:db8:a::b1d4]:11111"}
    ]
},
{
    "anchor":  "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/sec/pstat",
    "rt":  ["oic.r. pstat"],
    "if":  ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps":  [{"ep":  "coaps://[2001:db8:a::b1d4]:11111"}]
},
{
    "anchor":  "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/sec/cred",
    "rt":  ["oic.r. cred"],
    "if":  ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps":  [{"ep":  "coaps://[2001:db8:a::b1d4]:11111"}]
},
{
    "anchor":  "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/oic/sec/acl2",
    "rt":  ["oic.r. acl2"],
    "if":  ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps":  [{"ep":  "coaps://[2001:db8:a::b1d4]:11111"}]
},
{
    "anchor":  "ocf://e61c3e6b-9c54-4b81-8ce5-f9039c1d04d9",
    "href": "/myIntrospection",
    "rt":  ["oic.wk .introspection"],
    "if":  ["oic.if .r",  "oic.if .baseline"],
    "p": {"bm": 3},
    "eps":  [{"ep": "coaps://[2001:db8:a::b1d4]:11111"}]
},

{
    "anchor": "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/res",
    "rt":  ["oic.wk .res"],
    "if":  ["oic.if .ll", "oic.if.baseline"],
    "p": {"bm": 3},
    "eps":  [
        {"ep":  "coap://[2001:db8:a::b1d4]:66666"},
        {"ep":  "coaps://[2001:db8:a::b1d4]:22222"}
    ]
},
{
    "anchor": "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/d",
    "rt":  ["oic.wk .d",  "oic.d. light",  "oic .d.virtual"],
    "if":  ["oic.if .r",  "oic.if .baseline"],
    "p": {"bm": 3},
    "eps": [
        {"ep":  "coap://[2001:db8:a::b1d4]:66666"},
        {"ep":  "coaps://[2001:db8:a::b1d4]:22222"}
    ]
},
{
    "anchor":  "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/p",
    "rt":  ["oic.wk .p"],
    "if":  ["oic.if .r",  "oic.if .baseline"],
    "p": {"bm": 3},
    "eps":  [
        {"ep": "coap://[2001:db8:a::b1d4]:66666"},
        {"ep": "coaps://[2001:db8:a::b1d4]:22222"}
    ]
},
{
    "anchor":  "ocf://dc70373c- 1e8d -4fb3-962e-017eaa863989",
    "href": "/myLight",
    "rt":  ["oic.r. switch.binary"],
    "if":  ["oic.if .a",  "oic.if .baseline"],
    "p": {"bm": 3},
    "eps":  [{"ep":  "coaps://[2001:db8:a::b1d4]:22222"}]
},
{
    "anchor":  "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/sec/doxm",
    "rt":  ["oic.r. doxm"],
    "if":  ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps":  [
        {"ep": "coap://[2001:db8:a::b1d4]:66666"},
        {"ep": "coaps://[2001:db8:a::b1d4]:22222"}
    ]
},
{
    "anchor": "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/sec/pstat",
    "rt": ["oic.r.pstat"],
    "if": ["oic.if.baseline"],
    "p": {"bm": 1},
    "eps": [{"ep": "coaps://[2001:db8:a::b1d4]:22222"}] 
}, 
{
    "anchor":  "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/sec/cred",
    "rt": ["oic.r. cred"],
    "if": ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps":  [{"ep": "coaps://[2001:db8:a::b1d4]:22222"}]
},
{
    "anchor":  "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/oic/sec/acl2",
    "rt":  ["oic.r. acl2"],
    "if":  ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps":  [{"ep":  "coaps://[2001:db8:a::b1d4]:22222"}]
},
{
    "anchor":  "ocf://dc70373c-1e8d-4fb3-962e-017eaa863989",
    "href": "/myLightIntrospection",
    "rt":  ["oic.wk.introspection"],
    "if":  ["oic.if.r", "oic.if .baseline"],
    "p": {"bm": 3},
    "eps":  [{"ep":  "coaps://[2001:db8:a::b1d4]:22222"}]
},
{
    "anchor":  "ocf://88b7c7f0-4b51-4e0a-9faa-cfb439fd7f49",
    "href": "/oic/res",
    "rt":  ["oic.wk .res"],
    "if":  ["oic.if .ll", "oic.if.baseline"],
    "p": {"bm": 3},
    "eps":  [
        {"ep":  "coap://[2001:db8:a::b1d4]:77777"},
        {"ep":  "coaps://[2001:db8:a::b1d4]:33333"}
    ]
},
{

"anchor": "ocf://88b7c7f0-4b51-4e0a-9faa-cfb439fd7f49",

"href": "/oic/d",

"rt":  ["oic.wk.d", "oic.d.fan", "oic.d .virtual"],
"if":  ["oic.if.r", "oic.if.baseline"],

"p": {"bm": 3},

"eps":  [{"ep":  "coap://[2001:db8:a::b1d4]:77777"},

{"ep":  "coaps://[2001:db8:a::b1d4]:33333"}]
},

{
"anchor": "ocf://88b7c7f0-4b51-4e0a-9faa-cfb439fd7f49",
"href": "/oic/p",
"rt":  ["oic.wk.p"],
"if":  ["oic.if.r",  "oic.if.baseline"],
"p": {"bm": 3},
"eps":  [{"ep":  "coap://[2001:db8:a::b1d4]:77777"},
{"ep":  "coaps://[2001:db8:a::b1d4]:33333"}]
},

{
"anchor":  "ocf://88b7c7f0-4b51-4e0a-9faa-cfb439fd7f49",
"href": "/myFan",
"rt":  ["oic.r.switch.binary"],
"if":  ["oic.if.a", "oic.if.baseline"],
"p": {"bm": 3},
"eps":  [{"ep": "coaps://[2001:db8:a::b1d4]:33333"}]
},
{
"anchor":  "ocf://88b7c7f0- 4b51 -4e0a-9faa-cfb439fd7f49",
"href": "/oic/sec/doxm",
"rt":  ["oic.r. doxm"],
"if":  ["oic.if .baseline"],
"p": {"bm": 1},
"eps":  [{"ep":  "coap://[2001:db8:a::b1d4]:77777"},
{"ep":  "coaps://[2001:db8:a::b1d4]:33333"}]
},
{
"anchor":  "ocf://88b7c7f0- 4b51 -4e0a-9faa-cfb439fd7f49",
"href": "/oic/sec/pstat",
"rt":  ["oic.r. pstat"],
"if":  ["oic.if .baseline"],
"p": {"bm": 1},
"eps":  [{"ep": "coaps://[2001:db8:a::b1d4]:33333"}]
},
{
    "anchor": "ocf://88b7c7f0-4b51-4e0a-9faa-cfb439fd7f49",
    "href": "/oic/sec/cred",
    "rt": ["oic.r.cred"],
    "if": ["oic.if.baseline"],
    "p": {"bm": 1},
    "eps":  [{"ep": "coaps://[2001:db8:a::b1d4]:33333"}]
},
{
    "anchor": "ocf://88b7c7f0-4b51-4e0a-9faa-cfb439fd7f49",
    "href": "/oic/sec/acl2",
    "rt": ["oic.r. acl2"],
    "if": ["oic.if .baseline"],
    "p": {"bm": 1},
    "eps": [{"ep": "coaps://[2001:db8:a::b1d4]:33333"}]
},
{
    "anchor": "ocf://88b7c7f0- 4b51-4e0a-9faa-cfb439fd7f49",
    "href": "/myFanIntrospection",
    "rt": ["oic.wk.introspection"],
    "if": ["oic.if.r",  "oic.if .baseline"],
    "p": {"bm": 3},
    "eps":  [{"ep": "coaps://[2001:db8:a::b1d4]:33333"}]
}
]
```

Точный формат ответа «/ oic / res» и способ для клиента получить ответное сообщение «/ oic / res» указаны в D.9 и 11.3.5 соответственно.

## 10.4   CoAP based Endpoint discovery

Ниже описано обнаружение Endpoint CoAP:

a) Устройства должны присоединяться к многоадресным группам «Все OCF-узлы» (как определено в [IANA IPv6 Multicast Address Space Registry]) с областями 2, 3 и 5 (то есть ff02::158, ff03::158 и ff05::158) и прослушивает порт 5683. Для соответствия IETF RFC 7252 устройство может дополнительно присоединяться к группам многоадресной передачи «All CoAP Nodes».

б) Клиенты, намеревающиеся обнаруживать ресурсы, должны присоединяться к группам многоадресной рассылки, как определено в а).

c) Устройства должны выставлять «/oic/res» через незащищенную конечную точку.

d) Клиенты должны отправлять запросы на обнаружение (запрос GET) в адрес групповой группы «Все узлы OCF» с областью действия 2 (ff02 :: 158) в порту 5683. Запрошенный URI должен быть «/oic/res». Для соответствия IETF RFC 7252 Клиент может дополнительно отправлять в группы «Все кодовые узлы» многоадресные группы.

e) Если запрос обнаружения предназначен для определенного типа ресурсов, в запрос (раздел 6.2.1) должен быть включен параметр запроса «rt» с его значением, установленным в желаемый тип ресурса. Только Устройства, на которых размещается Тип ресурса, должны отвечать на запрос обнаружения.

f) Когда параметр «rt» Query опущен, все Устройства должны ответить на запрос обнаружения.

g) Обработка запросов многоадресной передачи должна быть такой, как описано в разделе 8 IETF RFC 7252 и разделе 4.1 в IETF RFC 6690.

h) Устройства, которые получают запрос, должны реагировать с использованием кодирования полезной нагрузки CBOR. Устройство должно указывать поддержку кодирования полезной нагрузки CBOR для обнаружения многоадресной передачи, как описано в разделе 12.4.

